apiVersion: mongodbcommunity.mongodb.com/v1
kind: MongoDBCommunity
metadata:
  name: repairdb-rs
  namespace: roadride
spec:
  version: "8.0.1"
  type: ReplicaSet
  members: 1
  security:
    authentication:
      modes:
        - SCRAM
  users:
    - name: root
      db: admin
      passwordSecretRef:
        name: mongodb-admin-secret
        key: MONGO_INITDB_ROOT_PASSWORD
      roles:
        - name: clusterAdmin
          db: admin
        - name: userAdminAnyDatabase
          db: admin
      scramCredentialsSecretName: repairdb-rs-root-scram
  statefulSet:
    spec:
      template:
        spec:
          containers:
            - name: mongod
              resources:
                limits:
                  cpu: "500m"
                  memory: "1Gi"
                requests:
                  cpu: "250m"
                  memory: "512Mi"
              lifecycle:
                postStart:
                  exec:
                    command:
                      - /bin/sh
                      - -c
                      - |
                        if [ -z "$(mongosh --quiet --eval 'rs.status().ok')" ]; then
                          mongosh --eval 'rs.initiate({ _id: "rs0", members: [{ _id: 0, host: "'$HOSTNAME'.repairdb-rs-svc.roadride.svc.cluster.local:27017" }] })'
                        fi
              volumeMounts:
                - name: mongodbdata
                  mountPath: /data/db
            # Add this to override agent defaults (operator respects it)
            - name: mongodb-agent
              resources:
                requests:
                  cpu: "100m"  # Reduced from 500m
                  memory: "128Mi"  # Reduced from 400Mi
                limits:
                  cpu: "250m"  # Reduced from 1
                  memory: "256Mi"  # Reduced from 500Mi
          # Optional: Reduce init container requests (they run sequentially but count for scheduling)
          initContainers:
            - name: mongod-posthook
              resources:
                requests:
                  cpu: "100m"  # Reduced from 500m
                  memory: "128Mi"  # Reduced from 400Mi
                limits:
                  cpu: "250m"
                  memory: "256Mi"
            - name: mongodb-agent-readinessprobe
              resources:
                requests:
                  cpu: "100m"  # Reduced from 500m
                  memory: "128Mi"  # Reduced from 400Mi
                limits:
                  cpu: "250m"
                  memory: "256Mi"
      volumeClaimTemplates:
        - metadata:
            name: mongodbdata
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 2Gi
            storageClassName: standard
