kubectl apply -f k8s/app-configmap.yaml
kubectl apply -f k8s/kafka-deployment.yaml
kubectl apply -f k8s/schema-registry-deployment.yaml
kubectl apply -f k8s/kafka-app/kafka-app-deployment.yaml
# Restart port-forward
kubectl port-forward svc/schema-registry-svc 8081:8081 -n roadride &

# Tail SR logs for clues (look for "Master elected" or Kafka errors; Ctrl+C after ~1 min)
kubectl logs deployment/schema-registry -n roadride -f

# In another terminal, wait 60s then retry registration
sleep 60
SCHEMA_JSON=$(cat repair_event.avsc | jq -c .)
PAYLOAD=$(jq -n -c --arg schema "$SCHEMA_JSON" '{schema: $schema}')
curl -X POST -H "Content-Type: application/vnd.schemaregistry.v1+json" \
  --data "$PAYLOAD" \
  http://localhost:8081/subjects/repair.service+RepairEvent-value/versions

# If still 50002, add a longer timeout hint in payload (SR ignores it, but retry with delay)
saleep 10 && curl http://localhost:8081/subjects/repair.service+RepairEvent-value/versions/latest | jq .
