helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update
confluentinc/cp-kafka

eval $(minikube docker-env)
minikube start --memory=7500
kubectl create namespace roadride
kubectl config set-context --current --namespace=roadride

helm install kafka bitnami/kafka \
  -f kafka-values.yaml \
  --namespace roadride

kubectl port-forward svc/kafka 9092:9092 -n roadride &

helm install schema-registry bitnami/schema-registry \
  -f sr-values.yaml \
  --namespace roadride

kubectl port-forward svc/schema-registry 8081:8081 -n roadride &

KAFKA_PASSWORD=$(kubectl get secret kafka-user-passwords --namespace roadride -o jsonpath='{.data.client-passwords}' | base64 -d | cut -d , -f 1)
echo $KAFKA_PASSWORD  # Verify it's correct (should be a hashed-like string)


docker run --rm \
  -e KAFKA_OPTS="-Djava.security.auth.login.config=/etc/kafka/kafka_client_jaas.conf" \
  confluentinc/cp-kafka:latest \
  /bin/bash -c "
    echo 'org.apache.kafka.common.security.scram.ScramLoginModule required username=\"user1\" password=\"$KAFKA_PASSWORD\";' > /etc/kafka/kafka_client_jaas.conf &&
    kafka-topics --create --bootstrap-server kafka.roadride.svc.cluster.local:9092 \
      --command-config /etc/kafka/client.properties --topic test --partitions 1 --replication-factor 1
  "
